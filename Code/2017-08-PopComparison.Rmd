---
output: 
  html_document:
    fig_height: 10
    fig_width: 10
---

# Preliminaries

Loading libraries

```{r libraries}
library(ggplot2)
library(dplyr)
library(ggpubr)
```

Loading databases

```{r databases}
setwd('..')
path <- getwd()
setwd(paste(path, "/Results/MergedData", sep = ""))
#Read data
load("MergedDat.RData")
```

# Data cleaning

I'll remove participants without Male or Female self-identified sex

```{r data cleaning}
MergedDat[[1]]$IID[!(MergedDat[[1]]$Sex == "Male" | MergedDat[[1]]$Sex == "Female")]
cleanSex       <- MergedDat[[1]]$Sex == "Male" | MergedDat[[1]]$Sex == "Female"
MergedDat[[1]] <- dplyr::filter(MergedDat[[1]], cleanSex)
MergedDat[[2]] <- dplyr::filter(MergedDat[[2]], cleanSex)
MergedDat[[3]] <- dplyr::filter(MergedDat[[3]], cleanSex)
MergedDat[[1]]$Sex <- droplevels(MergedDat[[1]]$Sex)
```


# Descriptive and exploratory analyses

```{r summary}
summary(MergedDat[[1]])
MergedDat[[1]] %>% group_by(continent) %>% select(Age, Height, Weight) %>% 
  summarise_all(funs(mean(. , na.rm = T), median(. , na.rm = T), sd(. , na.rm = T)))
```

We can compare at the distributions of PCs for each geographical group

```{r joyplots}
source("PlotPCs.R")
p1 <- PlotPCs(MergedDat[[2]], MergedDat[[1]]$continent, "PC1", "PC9")
p2 <- PlotPCs(MergedDat[[2]], MergedDat[[1]]$continent, "PC10", "PC19")
p3 <- PlotPCs(MergedDat[[2]], MergedDat[[1]]$continent, "PC20", "PC29")
p4 <- PlotPCs(MergedDat[[2]], MergedDat[[1]]$continent, "PC30", "PC39")
ggarrange(p1, p2, p3, p4,
          common.legend = TRUE, legend = "right", 
          align = "v")

p1 <- PlotPCs(MergedDat[[2]], MergedDat[[1]]$continent, "PC40", "PC49")
p2 <- PlotPCs(MergedDat[[2]], MergedDat[[1]]$continent, "PC50", "PC59")
p3 <- PlotPCs(MergedDat[[2]], MergedDat[[1]]$continent, "PC60", "PC69")
p4 <- PlotPCs(MergedDat[[2]], MergedDat[[1]]$continent, "PC70", "PC79")
ggarrange(p1, p2, p3, p4,
          common.legend = TRUE, legend = "right", 
          align = "v")
```

# Hypohtesis testing

We'll test whether group average differ between groups, by using a 5x2 design using continent and Sex as grouping variables

```{r MANOVA}
fit <- manova(as.matrix(MergedDat[[2]]) ~ MergedDat[[1]]$Sex * MergedDat[[1]]$continent)
summary(fit, test="Hotelling-Lawley")
summary(fit, test="Wilks")
summary(fit, test="Roy")
summary(fit, test="Pillai")
```

we can compute pairwise mahalanobis distance as a measure of effect size.

```{r}
library(HDMD)
madist <- pairwise.mahalanobis(MergedDat[[2]], MergedDat[[1]]$continent)
levels(MergedDat[[1]]$continent)
madist$distance
```

# Vectors comparison

Another approach is to calculate the sexual dimorphism vectors for each population, and compare them.

```{r vector calculation}
consensus <- MergedDat[[2]] %>% group_by(MergedDat[[1]]$continent, MergedDat[[1]]$Sex) %>%
             summarise_all(funs(mean))
colnames(consensus)[c(1,2)] <- c("continent", "Sex")
consensus$groups <- paste(consensus$continent, consensus$Sex, sep = ".")

plotsdmeans <- function(PCA, x1, y1) 
{ 
  p1 <- ggplot(PCA, aes_string(x = x1, y = y1)) + 
            geom_point(alpha = 0.05) +
            geom_point(data = consensus, 
                       aes_string(
                         x = x1, y = y1,
                         color = "consensus$groups"), 
                       size = 4) +
            scale_color_discrete(name = "Groups") +
            theme_pubr()
  p1 <- ggpar(p1, palette = "jama")
  return(p1)
}

p1 <- plotsdmeans(MergedDat[[2]], "PC1", "PC2")
p2 <- plotsdmeans(MergedDat[[2]], "PC3", "PC4")
p3 <- plotsdmeans(MergedDat[[2]], "PC5", "PC6")
p4 <- plotsdmeans(MergedDat[[2]], "PC7", "PC8")
ggarrange(p1, p2, p3, p4, nrow = 2, ncol = 2,
          common.legend = TRUE, legend = "top", 
          align = "v")
```

We can compare the vector of total SD between populations

```{r vector comparison}
totalSD <- matrix(0, ncol = 88, nrow = 5)
totalSD <- data.frame(totalSD)
totalSD[,1] <- levels(consensus$continent)
colnames(totalSD) <- c("continent", colnames(MergedDat[[2]]))

row <- 1
for(i in seq(1, 10, 2)){
  totalSD[row, 2:88] <- consensus[i, 3:89] - consensus[i+1, 3:89] 
  row = row + 1
}

plotvect <- function(PCA, x1, y1)
{
  p1 <- ggplot(PCA, aes_string(x = x1, y = y1)) +
            geom_point(alpha = 0.05) + 
            geom_segment(data = totalSD, 
                         aes_string(x = 0, y = 0,
                                    xend = paste("totalSD$", x1, "*3", sep = ""), 
                                    yend = paste("totalSD$", y1, "*3", sep = ""),
                                    color = "totalSD$continent"), 
                 arrow = arrow(length = unit(0.03, "npc")), size = 1) +
            scale_color_discrete(name = "Continent") + 
            theme_pubr()
  p1 <- ggpar(p1, palette = "jama")
  return(p1)
}

p1 <- plotvect(MergedDat[[2]], "PC1", "PC2")
p2 <- plotvect(MergedDat[[2]], "PC3", "PC4")
p3 <- plotvect(MergedDat[[2]], "PC5", "PC6")
p4 <- plotvect(MergedDat[[2]], "PC7", "PC8")
p5 <- plotvect(MergedDat[[2]], "PC9", "PC10")
p6 <- plotvect(MergedDat[[2]], "PC11", "PC12")
ggarrange(p1, p2, p3, p4, p5, p6, nrow = 3, ncol = 2,
          common.legend = TRUE, legend = "top", 
          align = "v")
```

Angles between total SD vectors

```{r}
source("Distances.R")
ang <- getAngle(totalSD[1,2:88], totalSD[1,2:88])
ang
ma <- getPAngle(totalSD[,2:88])
ma
```

