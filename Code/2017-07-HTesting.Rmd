---
title: Hypothesis testing
output: 
  html_document: default
---

In this script we will see the preliminary hypothesis testing on the effects of sex on face shape, as well as the allometric and non-allometric decomposition of sexual dimorphism.

## Preliminaries

We will load the necessary libraries and datasets

```{r libraries dataset, warning=FALSE, message=FALSE}
library(ggplot2)
library(dplyr)
library(ggpubr)
library(Hotelling)
library(tidyr)
library(vegan)
library(HDMD)
library(car) #for Manova
setwd('..')
path <- getwd()
setwd(paste(path, "/Results/FacePCA", sep = ""))
coeffs   <- read.csv("coeffs.csv")
eigenvec <- read.csv("eigenvectors.csv", header=F)
eigenval <- read.csv("eigenvalues.csv", header=F)
means    <- read.csv("means.csv", header=F)
facets   <- read.csv("facets.csv", header=F)
coeffs$BMI <- coeffs$Weight / ((coeffs$Height/100)^2)
```

## Data cleaning

For data cleaning, we will remove every individual that is neither Male or Female, and individuals with NAs in any variable (Height, Weight, and Age)

```{r data cleaning}
coeffs = filter(coeffs, Sex == 'Female' | Sex == 'Male')
coeffs = droplevels(coeffs)
coeffs = na.omit(coeffs)
dim(coeffs)
head(coeffs[,1:8])
```

After cleaning, we end up with `r nrow(coeffs)` individuals

## Facial sexual dimorphism analysis

I will first test for differences in location between males in females in the face PCA.
I will first compare males and females location, using Hotelling's T^2^ statistic, which is a multivariate t-test.
The results are virtually identical when using a normalized PC space (not shown here).
Also, I will use the more involved PERMANOVA (Anderson 2001) using the mahalanobis distance between males and females.
The benefit of mahalanobis distance is that the within-group variance is taken into account, and not only the euclidean distance in space. 

```{r hotelling}
set.seed(10)
fit <- hotelling.test(.~Sex, data = coeffs[,c(2, 7:ncol(coeffs))])
fit
fit <- adonis(coeffs[ , 7:ncol(coeffs)] ~ coeffs$Sex, method="mahalanobis")
fit
```

We can also use the mahalanobis distance between group means as a measure of effect size.
In this case there is nothing else to compare with, so we show the mahalanobis distance between males and females in the whole dataset. 

```{r effect size}
madist <- pairwise.mahalanobis(coeffs[, 7:ncol(coeffs)], coeffs$Sex)
madist$distance
```

Remember to test the null hypothesis that the dispersions are identical between groups, using Anderson 2006

## Allometric and non-allometric components

In this section I will decompose the total facial sexual dimorphims (FSD) into its allometric and non-allometric components.
To generate the total FSD vector, we will regress face shape on sex, using age and BMI as covariates. 

```{r Total FSD and consensus faces}
#Multivariate regression
formula <- as.matrix(coeffs[,7:93]) ~ coeffs$Sex + coeffs$Age + coeffs$BMI
head(model.matrix(formula))
model   <- lm(as.matrix(coeffs[,7:93]) ~ coeffs$Sex + coeffs$Age + coeffs$BMI)
summary(manova(model), test="Pillai")
Manova(model)

#Calculating the average position
Males   <- colMeans(coeffs[coeffs$Sex == 'Male', 7:ncol(coeffs)])
Females <- colMeans(coeffs[coeffs$Sex == 'Female', 7:ncol(coeffs)])
consensus <- as.data.frame(t(data.frame(Males, Females)))
remove(Males, Females)
```

We can see the position of the average male and female faces in the first PCs.
The male and female consensus faces are highlighted to show their position in relation to the whole data set.

```{r consensus plots, fig.height=10, fig.width=10}
plotmeans <- function(matrix, means, factor, x1, y1)
{
  p1 <- ggplot(matrix, aes_string(x = x1, y = y1)) +
            geom_point(aes(colour = factor), alpha=0.1) +
            geom_point(data = means, aes_string(x = x1, y = y1), color="red", size=3) +
            theme_pubr()
  p1 <- ggpar(p1, palette = "jco")
  return(p1)
}
p1 <- plotmeans(coeffs[,7:ncol(coeffs)], consensus, coeffs$Sex, "PC1", "PC2")
p2 <- plotmeans(coeffs[,7:ncol(coeffs)], consensus, coeffs$Sex, "PC3", "PC4")
p3 <- plotmeans(coeffs[,7:ncol(coeffs)], consensus, coeffs$Sex, "PC5", "PC6")
p4 <- plotmeans(coeffs[,7:ncol(coeffs)], consensus, coeffs$Sex, "PC7", "PC8")
p5 <- plotmeans(coeffs[,7:ncol(coeffs)], consensus, coeffs$Sex, "PC9", "PC10")
p6 <- plotmeans(coeffs[,7:ncol(coeffs)], consensus, coeffs$Sex, "PC11", "PC12")

ggarrange(p1, p2, p3, p4, p5, p6, 
          ncol=2, nrow=3, 
          common.legend = T, legend = "top")
```

To obtain the allometric component, we run a multivariate linear regression. 
Also, we can compute manova tables to estimate the effect of Sex and Height on face shape (face PCs), showing that both are significant predictors. 

```{r MLR}
#Multivariate linear regression of height and sex on face
fit <- lm(as.matrix(coeffs[,7:ncol(coeffs)]) ~ coeffs$Sex + coeffs$Height)
summary(manova(fit), test="Pillai")
```

Furthermore, we can test whether there is a Sex by Height interaction

```{r MLR interaction}
#Multivariate linear regression of height and sex on face
fitint <- lm(as.matrix(coeffs[,7:ncol(coeffs)]) ~ coeffs$Sex * coeffs$Height)
summary(manova(fitint), test="Pillai")
```

To decompose the total FSD into its allometric and non-allometric components, we use the estimated effect of height on the face, scaled by the mean difference between females and males.

```{r fsd estimations}
consensus[3,] <- model$coefficients[2,]
consensus[4,] <- coef(fit)[3,] * (mean(coeffs[coeffs$Sex == 'Male',4]) - mean(coeffs[coeffs$Sex == 'Female',4]))
consensus[5,] <- as.numeric(consensus[3,]) - consensus[4,]
row.names(consensus) <- c("Males", "Females", "TotalSD", "Allometric", "Non-allometric")
```

We can graphically see the magnitude and direction of the vectors.
Note that in the plots, the vectors are scaled by 3.

```{r vectors, fig.height=10, fig.width=10, message=FALSE}
source("PlotPCs.R")
p1 <- plotvect(coeffs[,7:ncol(coeffs)], rownames(consensus)[3:5], consensus[3:5,], "PC1", "PC2")
p2 <- plotvect(coeffs[,7:ncol(coeffs)], rownames(consensus)[3:5], consensus[3:5,], "PC3", "PC4")
p3 <- plotvect(coeffs[,7:ncol(coeffs)], rownames(consensus)[3:5], consensus[3:5,], "PC5", "PC6")
p4 <- plotvect(coeffs[,7:ncol(coeffs)], rownames(consensus)[3:5], consensus[3:5,], "PC7", "PC8")
p5 <- plotvect(coeffs[,7:ncol(coeffs)], rownames(consensus)[3:5], consensus[3:5,], "PC9", "PC10")
p6 <- plotvect(coeffs[,7:ncol(coeffs)], rownames(consensus)[3:5], consensus[3:5,], "PC11", "PC12")

ggarrange(p1, p2, p3, p4, p5, p6, 
          ncol=2, nrow=3, 
          common.legend = T, legend = "top")
```

We export the fitted model and the vectors to visualize them as face shapes, [here](2017-07-FaceEffects.html).

```{r export}
setwd('..')
path <- getwd()
setwd(paste(path, "/Results/FSD", sep = ""))
write.csv(consensus, "vectors.csv", quote = F)
save(fit, file = "fitmodel.RData")
```