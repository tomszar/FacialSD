---
output: 
  html_document: default
  html_notebook: default
---

# Preliminaries

We will load the necessary libraries

```{r libraries, warning=FALSE}
library(ggplot2)
library(dplyr)
library(gridExtra)
library(Hotelling)
library(tidyr)
```

Setting wd and loading databases

```{r databases}
setwd('..')
path <- getwd()
setwd(paste(path, "/Results/PCA", sep = ""))
getwd()
#Read data
coeffs   <- read.csv("coeffs.csv")
eigenvec <- read.csv("eigenvectors.csv", header=F)
eigenval <- read.csv("eigenvalues.csv", header=F)
means    <- read.csv("means.csv", header=F)
facets   <- read.csv("facets.csv", header=F)
```

## Data cleaning

For data cleaning, we will remove every individual that is neither Male or Female, and individuals with NAs in any variable (Height, Weight, and Age)

```{r data cleaning}
#Remove no sex participants
coeffs = filter(coeffs, Sex == 'Female' | Sex == 'Male')
coeffs = droplevels(coeffs)
#Removed NAs from database
coeffs = na.omit(coeffs)
dim(coeffs)
```

After cleaning, we end up with `r nrow(coeffs)` individuals

# Facial sexual dimorphism analysis

Comparing males and females, using Hotelling's T^2 statistic. The results are virtually identical when using a normalized PC space (not shown here)

```{r hotelling}
set.seed(10)
fit = hotelling.test(.~Sex, data = coeffs[,c(2, 6:ncol(coeffs))])
fit
```

We can use the mahalanobis distance between group means as a meassure of effect size  

```{r effect size}
library(HDMD)
madist <- pairwise.mahalanobis(coeffs[, 6:ncol(coeffs)], coeffs$Sex)
madist$distance
```

# Alloemtric and non-allometric components

First, we will create consensus faces, taking the average male and female

```{r consensus faces}
Males   <- colMeans(coeffs[coeffs$Sex == 'Male', 6:ncol(coeffs)])
Females <- colMeans(coeffs[coeffs$Sex == 'Female', 6:ncol(coeffs)])
consensus <- as.data.frame(t(data.frame(Males, Females)))
remove(Males, Females)
```

This are scatter plots with PC1 with PC2, and PC3 with PC4. The male and female consensus faces are highlighted to show their position in relation to the whole data set.

```{r consensus plots, fig.height=8, fig.width=12}
p1 <- ggplot(coeffs, aes(PC1, PC2, colour=Sex)) + geom_point(alpha=0.1) + 
             geom_point(data = consensus, aes(PC1, PC2), color="red", size=3) + theme_bw()

p2 <- ggplot(coeffs, aes(PC3, PC4, colour=Sex)) + geom_point(alpha=0.1) + 
             geom_point(data = consensus, aes(PC3, PC4), color="red", size=3) + theme_bw()

p3 <- ggplot(coeffs, aes(PC5, PC6, colour=Sex)) + geom_point(alpha=0.1) + 
             geom_point(data = consensus, aes(PC5, PC6), color="red", size=3) + theme_bw()

p4 <- ggplot(coeffs, aes(PC7, PC8, colour=Sex)) + geom_point(alpha=0.1) + 
             geom_point(data = consensus, aes(PC7, PC8), color="red", size=3) + theme_bw()

grid.arrange(p1, p2, p3, p4, ncol=2)
```

To estimate the total FSD we substract the male consensus face to the female one

```{r totalFSD}
consensus[3,] <- consensus[2,] - consensus[1,]
row.names(consensus) <- c("Males", "Females", "TotalSD")
```

To obtain the allometric component, we run a multivariate linear regression. Also, we can compute manova tables to estimate the effect of Sex and Height on face shape (face PCs) 

```{r MLR}
#Multivariate linear regression of height and sex on face
fit <- lm(as.matrix(coeffs[,6:ncol(coeffs)]) ~ coeffs$Sex + coeffs$Height)
summary(manova(fit), test="Hotelling-Lawley")
summary(manova(fit), test="Wilks")
summary(manova(fit), test="Roy")
summary(manova(fit), test="Pillai")
```

Furthermore, we can test whether there is a Sex by Height interaction

```{r MLR interaction}
#Multivariate linear regression of height and sex on face
fitint <- lm(as.matrix(coeffs[,6:ncol(coeffs)]) ~ coeffs$Sex * coeffs$Height)
summary(manova(fitint), test="Hotelling-Lawley")
summary(manova(fitint), test="Wilks")
summary(manova(fitint), test="Roy")
summary(manova(fitint), test="Pillai")
```


Allometric and non-allometric components estimation

```{r fsd estimations}
consensus[4,] <- coef(fit)[3,] * (mean(coeffs[coeffs$Sex == 'Female',4]) - mean(coeffs[coeffs$Sex == 'Male',4]))
consensus[5,] <- as.numeric(consensus[3,]) - consensus[4,]
row.names(consensus) <- c("Males", "Females", "TotalSD", "Allometric", "Non-allometric")
```

Plot with SD vectors highlighted

```{r vectors, fig.height=6, fig.width=12}
p1 = ggplot(coeffs, aes(PC1, PC2, colour=Sex)) + geom_point(alpha=0.1) +
    geom_point(data = consensus[1:2, ], aes(PC1, PC2), color="red", size=5) + 
    geom_segment(aes(x = 0, y = 0, xend = consensus[4,1]*5, yend = consensus[4,2]*5), 
                 arrow = arrow(length = unit(0.03, "npc")), size = 1, color="yellow4") + 
    geom_segment(aes(x = 0, y = 0, xend = consensus[3,1]*5, yend = consensus[3,2]*5), 
                 arrow = arrow(), size = 2, color = "navy") + 
    geom_segment(aes(x = 0, y = 0, xend = consensus[5,1]*5, yend = consensus[5,2]*5), 
                 arrow = arrow(length = unit(0.03, "npc")), size = 1, color="green4")

p2 = ggplot(coeffs, aes(PC3, PC4, colour=Sex)) + geom_point(alpha=0.1) +
    geom_point(data = consensus[3:4,], aes(PC3, PC4), color="red", size=5) + 
    geom_segment(aes(x = 0, y = 0, xend = consensus[4,3]*5, yend = consensus[4,4]*5), 
                 arrow = arrow(length = unit(0.03, "npc")), size = 1, color="yellow4") + 
    geom_segment(aes(x = 0, y = 0, xend = consensus[3,3]*5, yend = consensus[3,4]*5), 
                 arrow = arrow(), size = 2, color = "navy") + 
    geom_segment(aes(x = 0, y = 0, xend = consensus[5,3]*5, yend = consensus[5,4]*5), 
                 arrow = arrow(length = unit(0.03, "npc")), size = 1, color="green4")

grid.arrange(p1,p2, ncol=2)
```

```{r export}
setwd('..')
path <- getwd()
setwd(paste(path, "/Results/FSD", sep = ""))
write.csv(consensus, "vectors.csv", quote = F)
save(fit, file = "fitmodel.RData")
```