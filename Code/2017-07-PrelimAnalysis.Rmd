---
output: html_document
---

# Preliminaries

Calling libraries
```{r libraries, warning=FALSE}
library(ggplot2)
library(dplyr)
library(GGally)
library(plotly)
library(gridExtra)
library(IRdisplay)
```

Setting wd and loading databases
```{r databases}
setwd('..')
path <- getwd()
setwd(paste(path, "/Results/PCA", sep = ""))
getwd()
#Read data
coeffs   <- read.csv("coeffs.csv")
eigenvec <- read.csv("eigenvectors.csv", header=F)
means    <- read.csv("means.csv", header=F)
facets   <- read.csv("facets.csv", header=F)
```

## Data cleaning

```{r}
#Remove no sex participants
coeffs = filter(coeffs, Sex == 'Female' | Sex == 'Male')
coeffs = droplevels(coeffs)
#Removed NAs from database
coeffs = na.omit(coeffs)
dim(coeffs)
```

# Descriptive stats

```{r}
summary(coeffs[,2:5])
```

```{r}
ggpairs(coeffs, columns = 2:7, ggplot2::aes(colour=Sex, alpha = 0.2), 
       lower = list(continuous = "smooth"))
```

Creating consensus faces
```{r}
conm <- colMeans(coeffs[coeffs$Sex == 'Male', 6:ncol(coeffs)])
conf <- colMeans(coeffs[coeffs$Sex == 'Female', 6:ncol(coeffs)])
consensus <- as.data.frame(t(data.frame(conm, conf)))
```

Scatter plot with male and female consensus faces highlighted 
```{r}
plot1 <- ggplot(coeffs, aes(PC1, PC2, colour=Sex)) + geom_point(alpha=0.1) + 
            geom_point(data = consensus[,1:2], aes(PC1, PC2), color="red", size=3)

plot2 <- ggplot(coeffs, aes(PC3, PC4, colour=Sex)) + geom_point(alpha=0.1) + 
            geom_point(data = consensus, aes(PC3, PC4), color="red", size=3)

grid.arrange(plot1, plot2)
```

# Facial SD 

Total SD

```{r}
totalSD <- consensus[2,] - consensus[1,]
totalSD
```

This are the results from the multivariate linear regression, using different statistics. 

```{r}
#Multivariate linear regression of height and sex on face
fit <- lm(as.matrix(coeffs[,6:ncol(coeffs)]) ~ coeffs$Sex + coeffs$Height)
summary(manova(fit), test="Hotelling-Lawley")
summary(manova(fit), test="Wilks")
summary(manova(fit), test="Roy")
summary(manova(fit), test="Pillai")
```

Testing wheter there is a Sex * Height interaction

```{r}
#Multivariate linear regression of height and sex on face
fitint <- lm(as.matrix(coeffs[,6:ncol(coeffs)]) ~ coeffs$Sex * coeffs$Height)
summary(manova(fitint), test="Hotelling-Lawley")
summary(manova(fitint), test="Wilks")
summary(manova(fitint), test="Roy")
summary(manova(fitint), test="Pillai")
```



Allometric and non-allometric components

```{r}
allometricSD     <- coef(fit)[3,] * (mean(coeffs[coeffs$Sex == 'Female',4]) - mean(coeffs[coeffs$Sex == 'Male',4]))
non.allometricSD <- as.numeric(totalSD) - allometricSD
```

Plot with SD vectors highlighted

```{r}
p1 = ggplot(coeffs, aes(PC1, PC2, colour=Sex)) + geom_point(alpha=0.1) +
    geom_point(data = consensus[,1:2], aes(PC1, PC2), color="red", size=5) + 
    geom_segment(aes(x = 0, y = 0, xend = allometricSD[1]*5, yend = allometricSD[2]*5), 
                 arrow = arrow(length = unit(0.03, "npc")), size = 1, color="yellow4") + 
    geom_segment(aes(x = 0, y = 0, xend = totalSD[1,1]*5, yend = totalSD[1,2]*5), 
                 arrow = arrow(), size = 2, color = "navy") + 
    geom_segment(aes(x = 0, y = 0, xend = non.allometricSD[1]*5, yend = non.allometricSD[2]*5), 
                 arrow = arrow(length = unit(0.03, "npc")), size = 1, color="green4")

p2 = ggplot(coeffs, aes(PC3, PC4, colour=Sex)) + geom_point(alpha=0.1) +
    geom_point(data = consensus[,3:4], aes(PC3, PC4), color="red", size=5) + 
    geom_segment(aes(x = 0, y = 0, xend = allometricSD[3]*5, yend = allometricSD[4]*5), 
                 arrow = arrow(length = unit(0.03, "npc")), size = 1, color="yellow4") + 
    geom_segment(aes(x = 0, y = 0, xend = totalSD[1,3]*5, yend = totalSD[1,4]*5), 
                 arrow = arrow(), size = 2, color = "navy") + 
    geom_segment(aes(x = 0, y = 0, xend = non.allometricSD[3]*5, yend = non.allometricSD[4]*5), 
                 arrow = arrow(length = unit(0.03, "npc")), size = 1, color="green4")

grid.arrange(p1,p2)
```

```{r}
coords <- apply(as.matrix(coeffs[,6:ncol(coeffs)]) %*% t(as.matrix(eigenvec)), 1, function(x) x + t(means))
dim(coords)
```

```{r}
minhf <- coef(fit)[1,] + (coef(fit)[3,] * min(coeffs[,4]))
maxhf <- coef(fit)[1,] + (coef(fit)[3,] * max(coeffs[,4]))
minhm <- coef(fit)[1,] + coef(fit)[2,] + (coef(fit)[3,] * min(coeffs[,4]))
maxhm <- coef(fit)[1,] + coef(fit)[2,] + (coef(fit)[3,] * max(coeffs[,4]))
heigths <- as.data.frame(t(data.frame(minhf, maxhf, minhm, maxhm)))
ggplot(coeffs, aes(PC1, PC2, colour=Sex)) + geom_point(alpha=0.1) +
  geom_point(data = heigths, aes(PC1, PC2), color="red", size=5)

```

```{r}
coordsheight <- apply(as.matrix(heigths) %*% t(as.matrix(eigenvec)), 1, function(x) x + t(means))
coordssd     <- apply(as.matrix(rbind(2*totalSD, -2*totalSD)) %*% t(as.matrix(eigenvec)), 1, function(x) x + t(means))
```

```{r}
source("PlotFaces.R")
Plot2Faces(coordsheight[ ,1], coordsheight[,2], facets)
Plot2Faces(coordssd[ ,1], coordssd[,2], facets)
```


Plot with distances

Example for euclidean distance function
```{r}
source("Distances.R")
eucdist <- getDistance(coordsheight[ ,1], coordsheight[,2])
```


```{r}
source("PlotFaces.R")
Plot1Face(coordsheight[,1], facets, colormap=eucdist[,1])
```


```{r}

```

```{r}
facecolor <- rep("cornsilk", nrow(facets))
myPlot <- plot_ly(x=face1[,1], y=face1[,2], z=face1[,3], i = facets[, 1]-1, j = facets[, 2]-1, k = facets[, 3]-1, 
              facecolor = facecolor)
myPlot
```

