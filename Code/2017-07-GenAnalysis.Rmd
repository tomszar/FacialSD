---
output: 
  html_document:
    fig_width: 12 
    fig_height: 10 
---

# Preliminaries

Calling libraries

```{r libraries, warning=FALSE}
library(ggplot2)
library(dplyr)
library(GGally)
library(ggpubr)
```

Reading data

```{r databases}
setwd('..')
path <- getwd()
setwd(paste(path, "/Results/GenClustering", sep = ""))
pca.eigenval <- read.csv("Clus.eigenval", sep = "", header = F)
pca.eigenvec <- read.csv("Clus.eigenvec", sep = "", header = F)
```

## Data cleaning

Naming data columns

```{r naming cols}
PCnames <- sprintf("PC%s",seq(1:30))
colnames(pca.eigenvec) <- c("FID", "IID", PCnames)
```


Creating new column to plot hapmap pops against our samples.

```{r new column}
pca.eigenvec$database <- pca.eigenvec$FID 
pca.eigenvec$database[!(pca.eigenvec$FID == "ASW" | pca.eigenvec$FID == "CEU" | pca.eigenvec$FID == "CHB" | pca.eigenvec$FID == "CHD" | 
                          pca.eigenvec$FID == "GIH" | pca.eigenvec$FID == "JPT" | pca.eigenvec$FID == "LWK" | pca.eigenvec$FID == "MEX" |
                          pca.eigenvec$FID == "MKK" | pca.eigenvec$FID == "TSI" | pca.eigenvec$FID == "YRI")] <- "ADAPT"
```

Because plink output is a normalized PC, clustering did not achieved very good results. 
Now we de-normalized the PCA by multiplying de eigenvectors by the standard deviation.

```{r de-normalizing PCA}
pca.eigenvec[,3:32] <- t(c(as.matrix(pca.eigenval)) * t(as.matrix(pca.eigenvec[,3:32])))
```

I'll remove samples that contain the word genome (surely those are not in the face files), the word ver (those are controls from the are from the axiom arrays), the word gDNA, as well as those with the name A_103. I've seen that some of those are outliers in some PCs

```{r removing samples}
removed <- filter(pca.eigenvec, IID == "A_103" | grepl("^genome", IID) | 
                    grepl("^ver", IID) | grepl("^gDNA", IID)) %>% 
               select(contains("ID"))
removed
pca.eigenvec <- filter(pca.eigenvec, IID != "A_103" & !grepl("^genome", IID) & 
                         !grepl("^ver", IID) & !grepl("^gDNA", IID))
```
I removed `r nrow(removed)` samples.

We also have some outliers in PC5, and PC10. Probably there are also in some other lower PCs

```{r removing outliers, fig.height=4, fig.width=6}
p1 <- ggplot(pca.eigenvec, aes(PC5)) + geom_histogram()
p2 <- ggplot(pca.eigenvec, aes(PC10)) + geom_histogram()
ggarrange(p1, p2)

pca.eigenvec %>% filter(PC5 > 1) %>% select(contains("ID"))
pca.eigenvec %>% filter(PC10 < -0.5) %>% select(contains("ID"))
  
pca.eigenvec <- pca.eigenvec %>% filter(PC5 < 1 & PC10 > -0.5)

```


# Descriptive and exploratory analyses

Some summary stats

```{r summary}
summary(pca.eigenvec[,c(1,2,33)])
```
 
PCA screeplot

```{r screeplot, fig.height=4, fig.width=6} 
barplot(c(as.matrix(pca.eigenval)), names.arg=PCnames, 
       main = "Variances",
       xlab = "Principal Components",
       ylab = "Eigenvalue",
       col = "steelblue")
```

Looking at the HapMap populations: 

POP | Description 
----|------------
ASW | African ancestry in Southwest USA
CEU | Utah residents with Northern and Western European ancestry from the CEPH collection
CHB | Han Chinese in Beijing, China
CHD | Chinese in Metropolitan Denver, Colorado
GIH | Gujarati Indians in Houston, Texas
JPT | Japanese in Tokyo, Japan
LWK | Luhya in Webuye, Kenya
MXL | Mexican ancestry in Los Angeles, California
MKK | Maasai in Kinyawa, Kenya
TSI | Toscani in Italia
YRI | Yoruba in Ibadan, Nigeria 

```{r hapmap, echo=F}
plothap <- function(dat, x1, y1)
{
  p1 <- ggplot(dat, aes_string(x = x1, y = y1, color = "database")) +
            geom_point(alpha = 0.2) + theme_pubr()
  p1 <- ggpar(p1, palette = "jama")
  return(p1)
}

p1 <- plothap(filter(pca.eigenvec, database != "ADAPT"), "PC1", "PC2")
p2 <- plothap(filter(pca.eigenvec, database != "ADAPT"), "PC3", "PC4")
p3 <- plothap(filter(pca.eigenvec, database != "ADAPT"), "PC5", "PC6")
p4 <- plothap(filter(pca.eigenvec, database != "ADAPT"), "PC7", "PC8")
p5 <- plothap(filter(pca.eigenvec, database != "ADAPT"), "PC9", "PC10")
p6 <- plothap(filter(pca.eigenvec, database != "ADAPT"), "PC11", "PC12")

ggarrange(p1, p2, p3, p4, p5, p6, nrow = 3, ncol = 2,
          common.legend = TRUE, legend = "right")
```

```{r hapmap center, echo=F}
meanshap <- filter(pca.eigenvec, database != "ADAPT") %>% group_by(database) %>% 
                select(contains("PC")) %>% summarise_all(funs(mean))

plothapmeans <- function(dat, x1, y1){
  p1 <- ggplot(dat, aes_string(x = x1, y = y1, label = "database")) + 
          geom_label(aes(fill = database), colour = "white", fontface = "bold", alpha = 0.5) + 
          theme_pubr(legend = "none")
  p1 <- ggpar(p1, palette = "jama")
  return(p1)
}

p1 <- plothapmeans(meanshap, "PC1", "PC2")
p2 <- plothapmeans(meanshap, "PC3", "PC4")
p3 <- plothapmeans(meanshap, "PC5", "PC6")
p4 <- plothapmeans(meanshap, "PC7", "PC8")
p5 <- plothapmeans(meanshap, "PC9", "PC10")
p6 <- plothapmeans(meanshap, "PC11", "PC12")

ggarrange(p1, p2, p3, p4, p5, p6,
          nrow = 3, ncol = 2)
```

If we plot our samples together with the HapMap, we see the following

```{r hapmap plus adapt, echo=F}
plothapsamp <- function(dat1, dat2, x1, y1)
{
  p1 <- ggplot(dat1, aes_string(x = x1, y = y1, label = "database")) + 
          geom_point(data = dat2, 
                     aes_string(x = x1, y = y1), alpha = 0.4) + 
          geom_label(aes(fill = database), colour = "white", fontface = "bold", alpha = 0.4) + 
          theme_pubr(legend = "none")
  p1 <- ggpar(p1, palette = "jama")
  return(p1)
}
  
p1 <- plothapsamp(meanshap, filter(pca.eigenvec, database == "ADAPT"), "PC1", "PC2")
p2 <- plothapsamp(meanshap, filter(pca.eigenvec, database == "ADAPT"), "PC3", "PC4")
p3 <- plothapsamp(meanshap, filter(pca.eigenvec, database == "ADAPT"), "PC5", "PC6")
p4 <- plothapsamp(meanshap, filter(pca.eigenvec, database == "ADAPT"), "PC7", "PC8")
p5 <- plothapsamp(meanshap, filter(pca.eigenvec, database == "ADAPT"), "PC9", "PC10")
p6 <- plothapsamp(meanshap, filter(pca.eigenvec, database == "ADAPT"), "PC11", "PC12")

ggarrange(p1, p2, p3, p4, p5, p6,
          nrow = 3, ncol = 2)
```

Looking at our samples with population designation
```{r samples w/pop, echo=F}
plothapgroup <- function(dat1, dat2, x1, y1)
{
  p1 <- ggplot(dat1, aes_string(x = x1, y = y1, label = "database")) + 
          geom_point(data = dat2, aes_string(x = x1, y = y1, color = "FID"), alpha = 0.5) + 
          geom_label(aes(fill = database), colour = "white", fontface = "bold", alpha = 0.5) +
          theme_pubr()
  p1 <- ggpar(p1, palette = "jama")
  return(p1)
}

eurhap  <- filter(meanshap, database == "CEU" | database == "TSI")
eursamp <- filter(pca.eigenvec, FID == "Italian" | FID == "Polish" | FID == "Irish" | 
                            FID == "Portuguese")

p1 <- plothapgroup(eurhap, eursamp, "PC1", "PC2")
p2 <- plothapgroup(eurhap, eursamp, "PC3", "PC4")
p3 <- plothapgroup(eurhap, eursamp, "PC5", "PC6")
p4 <- plothapgroup(eurhap, eursamp, "PC7", "PC8")
p5 <- plothapgroup(eurhap, eursamp, "PC9", "PC10")
p6 <- plothapgroup(eurhap, eursamp, "PC11", "PC12")


ggarrange(p1, p2, p3, p4, p5, p6,
          nrow = 3, ncol = 2,
          common.legend = TRUE, legend = "right")
```

# Clustering

```{r clustering}
d  <- dist(as.matrix(pca.eigenvec[,3:32]))
hc <- hclust(d)
plot(hc)
pca.eigenvec$groups <- as.factor(cutree(hc, k=5)) # cut tree into 5 clusters
# draw dendogram with red borders around the 5 clusters
ggpairs(pca.eigenvec, mapping = aes(color = groups), columns = 3:12, upper = "blank", diag = NULL)
ggpairs(filter(pca.eigenvec, database != "ADAPT"), mapping = aes(color = groups), columns = 3:12, upper = "blank", diag = NULL)
ggpairs(filter(pca.eigenvec, database == "ADAPT"), mapping = aes(color = groups), columns = 3:12, upper = "blank", diag = NULL)

```

# Combining datasets

```{r read facedata}
setwd('..')
path <- getwd()
setwd(paste(path, "/Results/PCA", sep = ""))
getwd()
#Read data
coeffs   <- read.csv("coeffs.csv")
```

```{r merging, eval=F}
colnames(coeffs)[1] <- "IID"
total      <- merge(pca.eigenvec, coeffs, by = "IID") 
FacePCA    <- total[,39:125]
GenPCA     <- total[,3:32]
Covariates <- total[,c(1,2,34:38)]

PCnames <- sprintf("PC%s",seq(1:87))
colnames(FacePCA) <- PCnames

PCnames <- sprintf("PC%s",seq(1:30))
colnames(GenPCA) <- PCnames

MergedDat <- list(Covariates, FacePCA, GenPCA) 

setwd('..')
path <- getwd()
setwd(paste(path, "/Results/MergedData", sep = ""))
save(MergedDat, file = "MergedDat.RData")
```